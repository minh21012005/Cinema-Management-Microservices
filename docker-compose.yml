services:
  # ======================
  # üîπ Elasticsearch
  # ======================
#  elasticsearch:
#    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.3
#    container_name: elasticsearch
#    environment:
#      - discovery.type=single-node
#      - xpack.security.enabled=false
#      - ES_JAVA_OPTS=-Xms1g -Xmx1g
#    ports:
#      - "9200:9200"
#    volumes:
#      - elastic_data:/usr/share/elasticsearch/data
#    networks:
#      - monitoring
#    restart: always

  # ======================
  # üîπ Kibana
  # ======================
#  kibana:
#    image: docker.elastic.co/kibana/kibana:8.15.3
#    container_name: kibana
#    environment:
#      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
#    ports:
#      - "5601:5601"
#    depends_on:
#      - elasticsearch
#    networks:
#      - monitoring
#    restart: always

  # ======================
  # üîπ Logstash
  # ======================
#  logstash:
#    image: docker.elastic.co/logstash/logstash:8.15.3
#    container_name: logstash
#    ports:
#      - "5044:5044"
#    volumes:
#      - ./elk/logstash.conf:/usr/share/logstash/pipeline/logstash.conf:ro
#    depends_on:
#      - elasticsearch
#    networks:
#      - monitoring
#    restart: always

  # ======================
  # üîπ Prometheus
  # ======================
#  prometheus:
#    image: prom/prometheus:v2.55.1
#    container_name: prometheus
#    ports:
#      - "9090:9090"
#    volumes:
#      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
#    networks:
#      - monitoring
#    restart: always

  # ======================
  # üîπ Grafana
  # ======================
#  grafana:
#    image: grafana/grafana:11.1.0
#    container_name: grafana
#    ports:
#      - "3000:3000"
#    depends_on:
#      - prometheus
#    networks:
#      - monitoring
#    restart: always

  # ======================
  # üß∞ Redis
  # ======================
  redis:
    image: redis:7.4
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - monitoring
    restart: always

  # ======================
  # üì® RabbitMQ (v·ªõi giao di·ªán qu·∫£n l√Ω)
  # ======================
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: rabbitmq
    ports:
      - "5672:5672"   # C·ªïng cho app Spring Boot
      - "15672:15672" # Giao di·ªán web qu·∫£n l√Ω
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    networks:
      - monitoring
    restart: always

  # ======================
  # ü™£ MinIO (l∆∞u tr·ªØ file)
  # ======================
  minio:
    image: minio/minio:latest
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Web console
    volumes:
      - minio_data:/data
    networks:
      - monitoring
    restart: always

  # ======================
  # üß© MySQL Databases (healthcheck + restart)
  # ======================
  mysql-auth:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: 21012005
      MYSQL_DATABASE: auth_db
    ports:
      - "3307:3306"
    volumes:
      - ./sql/auth_db.sql:/docker-entrypoint-initdb.d/auth_db.sql:ro
      - mysql_auth_data:/var/lib/mysql
    networks:
      - monitoring
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  mysql-user:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: 21012005
      MYSQL_DATABASE: user_db
    ports:
      - "3308:3306"
    volumes:
      - ./sql/user_db.sql:/docker-entrypoint-initdb.d/user_db.sql:ro
      - mysql_user_data:/var/lib/mysql
    networks:
      - monitoring
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  mysql-cinema:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: 21012005
      MYSQL_DATABASE: cinema_db
    ports:
      - "3309:3306"
    volumes:
      - ./sql/cinema_db.sql:/docker-entrypoint-initdb.d/cinema_db.sql:ro
      - mysql_cinema_data:/var/lib/mysql
    networks:
      - monitoring
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  mysql-movie:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: 21012005
      MYSQL_DATABASE: movie_db
    ports:
      - "3310:3306"
    volumes:
      - ./sql/movie_db.sql:/docker-entrypoint-initdb.d/movie_db.sql:ro
      - mysql_movie_data:/var/lib/mysql
    networks:
      - monitoring
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  mysql-media:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: 21012005
      MYSQL_DATABASE: media_db
    ports:
      - "3311:3306"
    volumes:
      - ./sql/media_db.sql:/docker-entrypoint-initdb.d/media_db.sql:ro
      - mysql_media_data:/var/lib/mysql
    networks:
      - monitoring
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  mysql-booking:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: 21012005
      MYSQL_DATABASE: booking_db
    ports:
      - "3312:3306"
    volumes:
      - ./sql/booking_db.sql:/docker-entrypoint-initdb.d/booking_db.sql:ro
      - mysql_booking_data:/var/lib/mysql
    networks:
      - monitoring
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  mysql-content:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: 21012005
      MYSQL_DATABASE: content_db
    ports:
      - "3313:3306"
    volumes:
      - ./sql/content_db.sql:/docker-entrypoint-initdb.d/content_db.sql:ro
      - mysql_content_data:/var/lib/mysql
    networks:
      - monitoring
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  mysql-communication:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: 21012005
      MYSQL_DATABASE: communication_db
    ports:
      - "3314:3306"
    volumes:
      - ./sql/communication_db.sql:/docker-entrypoint-initdb.d/communication_db.sql:ro
      - mysql_communication_data:/var/lib/mysql
    networks:
      - monitoring
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  # ======================
  # üåç Discovery Server (Eureka)
  # ======================
  discovery-server:
    build: ./discovery-server
    container_name: discovery-server
    ports:
      - "8761:8761"
    environment:
      - EUREKA_SERVER_PORT=8761
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8761/eureka/apps" ]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - monitoring
    restart: always

  # ======================
  # üöÄ Spring Boot Microservices
  # Note: m·ªói service c·∫•u h√¨nh Eureka v√† Logstash ƒë·ªÉ register + g·ª≠i log
  # ======================
  auth-service:
    build: ./auth-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-auth:3306/auth_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=21012005
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=false
#      - LOGSTASH_HOST=logstash
#      - LOGSTASH_PORT=5044
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,prometheus
      - MAIL_USERNAME=minhhtestt@gmail.com
      - MAIL_PASSWORD=hmsu cwcg qsmq fekl
    depends_on:
      discovery-server:
        condition: service_healthy
      mysql-auth:
        condition: service_healthy
    networks:
      - monitoring
    restart: always

  user-service:
    build: ./user-service
    ports:
      - "8082:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-user:3306/user_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=21012005
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=false
#      - LOGSTASH_HOST=logstash
#      - LOGSTASH_PORT=5044
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,prometheus
    depends_on:
      discovery-server:
        condition: service_healthy
      mysql-user:
        condition: service_healthy
    networks:
      - monitoring
    restart: always

  cinema-service:
    build: ./cinema-service
    ports:
      - "8083:8083"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-cinema:3306/cinema_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=21012005
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=false
#      - LOGSTASH_HOST=logstash
#      - LOGSTASH_PORT=5044
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,prometheus
    depends_on:
      discovery-server:
        condition: service_healthy
      mysql-cinema:
        condition: service_healthy
    networks:
      - monitoring
    restart: always

  movie-service:
    build: ./movie-service
    ports:
      - "8084:8084"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-movie:3306/movie_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=21012005
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=false
#      - LOGSTASH_HOST=logstash
#      - LOGSTASH_PORT=5044
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,prometheus
    depends_on:
      discovery-server:
        condition: service_healthy
      mysql-movie:
        condition: service_healthy
    networks:
      - monitoring
    restart: always

  media-service:
    build: ./media-service
    ports:
      - "8085:8085"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-media:3306/media_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=21012005
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=false
#      - LOGSTASH_HOST=logstash
#      - LOGSTASH_PORT=5044
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,prometheus
    depends_on:
      discovery-server:
        condition: service_healthy
      mysql-media:
        condition: service_healthy
    networks:
      - monitoring
    restart: always

  booking-service:
    build: ./booking-service
    ports:
      - "8086:8086"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-booking:3306/booking_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=21012005
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=false
#      - LOGSTASH_HOST=logstash
#      - LOGSTASH_PORT=5044
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,prometheus
      - MAIL_USERNAME=minhhtestt@gmail.com
      - MAIL_PASSWORD=hmsu cwcg qsmq fekl
      - SEPAY_ACCOUNT=56711111111
      - SEPAY_API_KEY=WFEHMVASBLOGKRDFYONQPLEAR0SZX8D36TQBUKQHCCPK3KV92SEIZ75YVXI20IRF
      - SEPAY_BANK=TPBank
    depends_on:
      discovery-server:
        condition: service_healthy
      mysql-booking:
        condition: service_healthy
    networks:
      - monitoring
    restart: always

  content-service:
    build: ./content-service
    ports:
      - "8087:8087"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-content:3306/content_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=21012005
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=false
#      - LOGSTASH_HOST=logstash
#      - LOGSTASH_PORT=5044
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,prometheus
    depends_on:
      discovery-server:
        condition: service_healthy
      mysql-content:
        condition: service_healthy
    networks:
      - monitoring
    restart: always

  communication-service:
    build: ./communication-service
    ports:
      - "8088:8088"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-communication:3306/communication_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=21012005
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=false
#      - LOGSTASH_HOST=logstash
#      - LOGSTASH_PORT=5044
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,prometheus
    depends_on:
      discovery-server:
        condition: service_healthy
      mysql-communication:
        condition: service_healthy
    networks:
      - monitoring
    restart: always

  # ======================
  # üåê API Gateway
  # ======================
  api-gateway:
    build: ./api-gateway
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=false
      - SPRING_CLOUD_GATEWAY_DISCOVERY_LOCATOR_ENABLED=true
    depends_on:
      discovery-server:
        condition: service_healthy
    networks:
      - monitoring
    restart: always

# ======================
# üåê Network & Volumes
# ======================
networks:
  monitoring:

volumes:
  elastic_data:
  mysql_auth_data:
  mysql_user_data:
  mysql_cinema_data:
  mysql_movie_data:
  mysql_media_data:
  mysql_booking_data:
  mysql_content_data:
  mysql_communication_data:
  minio_data: